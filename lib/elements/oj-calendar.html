
<link rel="import" href="../bower_components/polymer/polymer.html"/>
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"/>
<dom-module id="oj-calendar">
  <!-- ----------------------------------------------------------------->
  <style>* {
  box-sizing: border-box;
}
.card-title {
  font-size: 1rem;
  line-height: 1.2em;
  font-weight: 700;
  font-family: P;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}
.oj-button-a {
  display: inline-block;
  width: 24rem;
  font-family: $P;
  font-weight: 700;
  color: $oj-violet;
  font-size: 1rem;
  text-align: center;
  letter-spacing: 0.1em;
  min-width: 7.5rem;
  border: 1px solid $oj-violet;
  box-shadow: 0 2px 4px 0 $oj-green;
  padding: 1.25rem 1rem;
}
.trap-top {
  position: fixed;
}
:host {
  width: 100%;
  color: #5200cc;
  display: -webkit-box;
  display: -moz-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: box;
  display: flex;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -o-box-orient: horizontal;
  -webkit-box-lines: multiple;
  -moz-box-lines: multiple;
  -o-box-lines: multiple;
  -webkit-flex-flow: row wrap;
  -ms-flex-flow: row wrap;
  flex-flow: row wrap;
  -webkit-box-pack: distribute;
  -moz-box-pack: distribute;
  -o-box-pack: distribute;
  -ms-flex-pack: distribute;
  -webkit-justify-content: space-around;
  justify-content: space-around;
}
:host .cell.header {
  font-family: 'P', 'Platform', 'Brandon', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  padding: 0.5rem 0.5rem 0.5rem 0;
  border-bottom: 1px solid rgba(82,0,204,0.4);
}
:host .cell.content {
  padding: 1rem 0.5rem 1rem 0;
  border-bottom: 1px solid rgba(82,0,204,0.4);
}
:host .cell.when {
  -webkit-flex-basis: 15%;
  flex-basis: 15%;
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -o-box-flex: 1;
  -ms-box-flex: 1;
  box-flex: 1;
  -webkit-flex-grow: 1;
  flex-grow: 1;
}
:host .cell.where {
  -webkit-flex-basis: 35%;
  flex-basis: 35%;
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -o-box-flex: 1;
  -ms-box-flex: 1;
  box-flex: 1;
  -webkit-flex-grow: 1;
  flex-grow: 1;
}
:host .cell.what {
  -webkit-flex-basis: 50%;
  flex-basis: 50%;
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -o-box-flex: 1;
  -ms-box-flex: 1;
  box-flex: 1;
  -webkit-flex-grow: 1;
  flex-grow: 1;
}

  </style>
  <!-- ----------------------------------------------------------------->
  <template>
    <div class="cell header when">Kiedy:</div>
    <div class="cell header where">Gdzie:</div>
    <div class="cell header what">Co:</div>
    <template is="dom-repeat" items="{{calendarEvents}}">
      <div class="cell content when"> <b>{{item.when.day}} </b><span>{{item.when.weekday}}</span></div>
      <div class="cell content where">{{item.where}}</div>
      <div class="cell content what">{{item.what}}</div>
    </template>
  </template>
  <!-- ----------------------------------------------------------------->
  <script>(function() {
  Polymer({
    is: 'oj-calendar',
    properties: {
      apiUrl: {
        type: String,
        value: 'https://www.googleapis.com/calendar/v3/'
      },
      limit: {
        type: Number,
        value: 10
      },
      apiKey: {
        type: String
      },
      calendarIds: {
        type: Array
      },
      maxResults: {
        type: Number,
        value: 20
      },
      showDays: {
        type: Number,
        value: 10
      },
      options: {
        type: Object,
        computed: 'computeOptions(apiKey, maxResults, showDays)'
      },
      calendarUrls: {
        type: String,
        computed: 'computeCalendarUrls(apiUrl, calendarIds)'
      },
      calendarEvents: {
        type: Array,
        value: function() {
          return [];
        }
      }
    },
    computeCalendarUrls: function(apiUrl, calendarIds) {
      return calendarIds.map(function(calID) {
        return apiUrl + 'calendars/' + calID + '/events';
      });
    },
    computeOptions: function(apiKey, maxResults, showDays) {
      return {
        key: apiKey,
        maxResults: maxResults,
        timeMin: moment('2016-01-01T02:07:39+02:00').format(),
        timeMax: moment().add(showDays, 'days').format(),
        orderBy: 'startTime',
        singleEvents: true
      };
    },
    getEvents: function(calendarUrls, options, limit) {
      return axios.all(calendarUrls.map(function(url) {
        return axios.get(url, {
          params: options
        });
      })).then(function(responses) {
        return responses.map(function(response) {
          return response.data.items;
        });
      }).then(function(calendars) {
        return calendars.reduce(function(prev, current) {
          return prev.concat(current);
        });
      }).then(function(events) {
        return events.map(function(event) {
          var dateString, whendate;
          dateString = event.start.dateTime || event.start.date;
          whendate = moment(dateString).locale('pl');
          return {
            when: {
              day: whendate.format('DD.MM'),
              weekday: whendate.format('dd')
            },
            where: event.organizer.displayName,
            what: event.summary
          };
        });
      }).then(function(events) {
        return events.sort(function(a, b) {
          var ref, ref1;
          return (ref = a.when < b.when) != null ? ref : {
            1: (ref1 = a.when > b.when) != null ? ref1 : -{
              1: 0
            }
          };
        });
      }).then(function(events) {
        return events.slice(0, limit);
      }).then((function(events) {
        return this.calendarEvents = events;
      }).bind(this))["catch"](function(error) {
        return console.log(error);
      });
    },
    ready: function() {
      this.getEvents(this.calendarUrls, this.options, this.limit);
    },
    attached: function() {},
    detached: function() {},
    _checkDeps: function() {
      var dep, deps, i, len, results, thisis;
      deps = ['axios'];
      thisis = this.is;
      results = [];
      for (i = 0, len = deps.length; i < len; i++) {
        dep = deps[i];
        results.push((function(dep) {
          if (typeof window[dep] === 'undefined') {
            return console.error(thisis + ' polymer element needs ' + dep);
          }
        })(dep));
      }
      return results;
    }
  });

}).call(this);

  </script>
</dom-module>